version: '3.8'

services:
  # PostgreSQL Database for Backend
  postgres:
    image: postgres:15-alpine
    container_name: physical-ai-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-physicalai}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      POSTGRES_DB: ${POSTGRES_DB:-physicalai_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U physicalai"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant Vector Database for RAG
  qdrant:
    image: qdrant/qdrant:latest
    container_name: physical-ai-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend FastAPI Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: physical-ai-backend
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-physicalai}:${POSTGRES_PASSWORD:-devpassword}@postgres:5432/${POSTGRES_DB:-physicalai_db}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 15
      REFRESH_TOKEN_EXPIRE_DAYS: 7
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

  # RAG Service
  rag:
    build:
      context: ./rag
      dockerfile: Dockerfile
    container_name: physical-ai-rag
    environment:
      QDRANT_URL: http://qdrant:6333
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-your-claude-api-key}
      OLLAMA_URL: ${OLLAMA_URL:-http://host.docker.internal:11434}
    ports:
      - "8001:8001"
    depends_on:
      qdrant:
        condition: service_healthy
    volumes:
      - ./rag:/app
    command: uvicorn src.main:app --host 0.0.0.0 --port 8001 --reload

  # Agent Service
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: physical-ai-agent
    environment:
      TRANSLATION_API_KEY: ${TRANSLATION_API_KEY:-}
    ports:
      - "8002:8002"
    volumes:
      - ./agent:/app
      - ./website/docs:/content/source
      - ./website/i18n:/content/translated
    command: python src/main.py

  # Website (Docusaurus) - Development Mode
  website:
    build:
      context: ./website
      dockerfile: Dockerfile
      target: development
    container_name: physical-ai-website
    environment:
      NODE_ENV: development
      BACKEND_API_URL: ${BACKEND_API_URL:-http://localhost:8000}
      RAG_WS_URL: ${RAG_WS_URL:-ws://localhost:8001}
    ports:
      - "3000:3000"
    volumes:
      - ./website:/app
      - /app/node_modules
    command: npm start

volumes:
  postgres_data:
  qdrant_storage:
